# :key: 토큰 기반 인증

[Velopert님의 설명](https://velopert.com/2350)
을 참고했다.

### :grey_question: 토큰을 사용하는 주요 이유

<span style="color:red">충분히 암호화된 상태</span>로 주고 받을 수 있고 <span style="color:red">critical한 데이터를 값 내부에 포함하지 않는다</span>

#### 1. Stateless 서버

- Stateful 서버 : 클라이언트에게서 요청을 받을 때마다, 클라이언트의 상태를 계속 유지하고, 이 정보를 서비스 제공에 이용한다. ex) 세션을 유지하는 웹 서버 </br>
  => Stateless 서버는 Stateful 서버와는 반대로 상태를 유지하지 않는다. 상태 정보를 저장하지 않으면 서버는 클라이언트와 서버의 연결고리가 없기 때문에 서버의 확장성이

#### 2. 모바일 어플리케이션에 적합하다.

- 모바일에서 개발한다면 안전한 API를 만들기 위해서는 쿠키 같은 인증 시스템은 이상적이지 않다. 쿠키 컨테이너를 사용해야 한다. 토큰 기반 인증을 도입하면 더 간단하게 해결할 수 있다.

#### 3. 인증 정보를 다른 어플리케이션으로 전달

- 대표적으로 OAuth가 있다. 페이스북/구글 같은 소셜 계정들을 이용하여 다른 웹 서비스에서도 로그인할 수 있게 한다.

#### 보안

- 토큰 기반 인증 시스템을 사용하여 어플리케이션의 보안을 높일 수 있다.

--- 

### :anguished: 과거의 인증 시스템

기존의 인증 시스템에서는 서버 측에서 유저들의 정보를 기억하고 있어야 했다. 세션을 유지하기 위해 메모리, 디스크, 데이터베이스 등 여러가지 방법이 사용되었다.
<img src="https://velopert.com/wp-content/uploads/2016/12/bb.png"/>
이러한 시스템은 아래와 같은 몇 가지 문제점이 있다.

- 세션
    - 유저가 인증할 때 서버는 이 기록을 서버에 저장해야 한다. 이를 세션이라고 부른다.대부분의 경우 메모리에 이를 저장하는데 로그인 중인 유저의 수가 늘어나면 서버의 램이 과부하 된다. 이것을 피하기 위해
      데이터베이스에 저장하기도 하지만 이 또한 유저의 수가 늘어나면 DB의 성능에 무리를 줄 수 있다.
- 확장성
    - 세션을 사용하면 서버 확장이 어려워진다. 여기서 서버의 확장이란 단순히 서버의 사양 업그레이드가 아니라 여러 개의 프로세스를 돌리거나, 여러 대의 서버 컴퓨터를 추가하는 것을 말한다.
- CORS(Cross-Origin Resource Sharing)
    - 웹 어플리케이션에서 세션을 관리할 때 자주 사용되는 쿠키는 단일 도메인 및 서브 도메인에서만 작동하도록 설계되어있다. 따라서 쿠키를 여러 도메인에서 관리하는 것은 번거롭다.

### :relaxed: 토큰 기반 시스템의 작동 원리

1. 유저가 아이디와 비밀번호로 **로그인**한다.
2. 서버 측에서 해당 **계정 정보를 검증**한다.
3. 계정 정보가 정확하다면 서버 측에서 유저에게 **signed 토큰을 발급**해준다.
    - signed 의 의미는 해당 토큰이 서버에서 정상적으로 발급된 토큰임을 증명하는 signature를 지니고 있다는 것이다.
4. 클라이언트 측에서 전달 받은 토큰을 저장해두고 서버에 요청을 할 때마다 해당 **토큰을 함께 서버에 전달**한다.
5. 서버는 **토큰을 검증**하고 **요청에 응답**한다.
   <img src="https://velopert.com/wp-content/uploads/2016/12/token-diagram.png"/>
   웹 서버에서 토큰을 서버에 전달할 때는 HTTP 요청의 헤더에 토큰 값을 포함해서 전달한다.

### :+1: 토큰의 장점

- #### Stateless(무상태)이며 확장성(Scalability)이 있다.
- #### 보안성
    - 클라이언트가 서버에 요청을 보낼 때 더 이상 쿠키를 보내지 않아 쿠키를 사용할 때 발생하는 취약점이 사라진다.
- #### Extensibility(확장성)
    - Scalability 와는 또 다른 개념이다. Scalability는 서버를 확장하는 것을 의미하지만 Extensibility는 로그인 정보가 사용되는 분야를 확장하는 것을 의미한다. 쿠팡에서 구글,
      카카오톡, 네이버 계정으로 로그인을 할 수 있다는 것이다. 이러한 토큰 기반 시스템에서는 토큰에 선택적인 권한을 부여하여 발급할 수도 있다.
- #### 여러 플랫폼 및 도메인
  - 어플리케이션과 서비스의 규모가 커지면 여러 디바이스를 호환 시키고 더 많은 종류의 서비스를 제공하게 된다. 토큰을 사용하면 어떤 디바이스, 도메인에서도 토큰만 유효하다면 요청이 정상적으로 처리된다. 서버 측에서 어플리케이션 응답 부분에 **아래와 같은 헤더만 포함 시켜주면 된다.**
```json
Access-Control-Allow-Origin: *
```
- #### 웹 표준 기반
  - 토큰 기반 인증 시스템의 구현체인 JWT는 웹 표준 RFC 7519에 등록되어 있다. 따라서 여러 환경에서 지원되며 수많은 회사의 인프라스트럭쳐에서 사용되고 있다.